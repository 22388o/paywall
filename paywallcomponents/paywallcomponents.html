<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Paywall Core Components</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

object, svg { display: inline-block; vertical-align: middle; }

.center { margin-left: auto; margin-right: auto; }

.spread { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #003b6b; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00579e; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #333333; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: Arial, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Arial, sans-serif; font-weight: normal; font-style: normal; color: #7b2d00; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #ff6b15; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #003426; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: Arial, sans-serif; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #e15200; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #e15200; }

blockquote, blockquote p { line-height: 1.6; color: #333333; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #d8d8ce; }
table thead, table tfoot { background: -webkit-linear-gradient(top, #add386, #90b66a); font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: white; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #6d6e71; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #edf2f2; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

body { -moz-osx-font-smoothing: grayscale; -webkit-font-smoothing: antialiased; tab-size: 4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; word-wrap: break-word; }
*:not(pre) > code.nobreak { word-wrap: normal; }
*:not(pre) > code.nowrap { white-space: nowrap; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

em em { font-style: normal; }

strong strong { font-weight: normal; }

.keyseq { color: #333333; }

kbd { font-family: Consolas, "Liberation Mono", Courier, monospace; display: inline-block; color: black; font-size: 0.65em; line-height: 1.45; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: 0 0.15em; padding: 0.2em 0.5em; vertical-align: middle; position: relative; top: -0.1em; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menuref { color: #000; }

.menuseq b:not(.caret), .menuref { font-weight: inherit; }

.menuseq { word-spacing: -0.02em; }
.menuseq b.caret { font-size: 1.25em; line-height: 0.8; }
.menuseq i.caret { font-weight: bold; text-align: center; width: 0.45em; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: #7b2d00; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #e15200; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #333333; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #333333; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: #7b2d00; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: Arial, sans-serif; list-style-type: none; }
#toc li { line-height: 1.3334; margin-top: 0.3334em; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #003b6b; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: white; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; margin-bottom: 0.8rem; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

#content { margin-bottom: 0.625em; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { #content { margin-bottom: 1.25em; }
  .sect1 { padding-bottom: 1.25em; } }
.sect1:last-child { padding-bottom: 0; }

.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #7b2d00; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #622400; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: #7b2d00; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #e15200; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #003b6b; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px dashed #666666; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 1.25em 1.5625em 1.125em 1.5625em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 1.25em 1.5625em 1.125em 1.5625em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; line-height: 1.6; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 0.75em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #333333; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #003b6b; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #e15200; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 0.75em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #333333; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.025em; color: #e15200; }

.quoteblock.abstract { margin: 0 0 0.75em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #d8d8ce; }

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock { border-width: 0 1px 1px 0; }

table.grid-all > tfoot > tr > .tableblock { border-width: 1px 1px 0 0; }

table.grid-cols > * > tr > .tableblock { border-width: 0 1px 0 0; }

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock { border-width: 0 0 1px 0; }

table.grid-rows > tfoot > tr > .tableblock { border-width: 1px 0 0 0; }

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock { border-bottom-width: 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: -webkit-linear-gradient(top, #add386, #90b66a); }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: white; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.checklist, ul.none, ol.none, ul.no-bullet, ol.no-bullet, ol.unnumbered, ul.unstyled, ol.unstyled { list-style-type: none; }

ul.no-bullet, ol.no-bullet, ol.unnumbered { margin-left: 0.625em; }

ul.unstyled, ol.unstyled { margin-left: 0; }

ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1.25em; font-size: 0.8em; position: relative; bottom: 0.125em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.inline { display: -ms-flexbox; display: -webkit-box; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; list-style: none; margin: 0 0 0.375em -0.75em; }

ul.inline > li { margin-left: 0.75em; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1, td.hdlist2 { vertical-align: top; padding: 0 0.625em; }

td.hdlist1 { font-weight: bold; padding-bottom: 0.75em; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist td:not([class]):first-child { padding: 0.4em 0.75em 0 0.75em; line-height: 1; vertical-align: top; }
.colist td:not([class]):first-child img { max-width: none; }
.colist td:not([class]):last-child { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; display: inline-block; }
a.image object { pointer-events: none; }

sup.footnote, sup.footnoteref { font-size: 0.875em; position: static; vertical-align: super; }
sup.footnote a, sup.footnoteref a { text-decoration: none; }
sup.footnote a:active, sup.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -0.25em 0 0.75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em 0 0.225em; line-height: 1.3334; font-size: 0.875em; margin-left: 1.2em; margin-bottom: 0.2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; margin-left: -1.05em; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }
a span.icon > .fa { cursor: inherit; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #004176; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { border-bottom: 1px solid #dddddd; }

.sect1 { padding-bottom: 0; }

#toctitle { color: #00406F; font-weight: normal; margin-top: 1.5em; }

.sidebarblock { border-color: #aaa; }

code { -webkit-border-radius: 4px; border-radius: 4px; }

p.tableblock.header { color: #6d6e71; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_paywall_core_components">Paywall Core Components</a>
<ul class="sectlevel2">
<li><a href="#paymenthandler">Payment Handler</a></li>
<li><a href="#_paymentrequired_annotation">@PaymentRequired Annotation</a></li>
<li><a href="#_payment_flows">Payment Flows</a></li>
<li><a href="#_customizing_paywall_components">Customizing Paywall Components</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_paywall_core_components">Paywall Core Components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Paywall framework is built up of a set of core components controlling the payment flow and
most of them are customizable. This chapter goes through the core parts of these components that are not
directly Spring Framework specific.</p>
</div>
<div class="paragraph">
<p>First are the most basic concepts in Paywall Framework, and that are required when using the framework are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>PaymentHandler</em>, that creates, updates and persist <em>PaymentData</em>.</p>
</li>
<li>
<p><em>PaymentData</em>, value object of a given payment state.</p>
</li>
<li>
<p><em>@PaymentRequired</em>, annotation that is set on API services that should trigger a payment flow.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then are the concept <em>PaymentFlow</em> described, that is in charge of directing the flow between
the different components.</p>
</div>
<div class="paragraph">
<p>Finally are other core components discussed, such as <em>LightningHandler</em> used to communicate with the lightning node, and
<em>CurrencyConverter</em> that is in charge of converting between FIAT and Crypto currency if needed.</p>
</div>
<div class="sect2">
<h3 id="paymenthandler">Payment Handler</h3>
<div class="paragraph">
<p>A PaymentHandler manages Orders, Invoices and Settlements in a payment flow and every application using Paywall
framework is required to implement one. The class is responsible to create and persist a value object of type
PaymentData.</p>
</div>
<div class="paragraph">
<p>A PaymentData that can be of different types depending on the level of control of the actual payment flow wanted or
the what types of payment related data that needs to be persisted.</p>
</div>
<div class="sect3">
<h4 id="_implementing_a_payment_handler_using_spring_framework">Implementing a Payment Handler using Spring Framework</h4>
<div class="paragraph">
<p>Using the Spring Framework, the easiest way to implement the payment handler is to create a class extending
<em>org.lightningj.paywall.spring.SpringPaymentHandler</em> and implement the following three methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">newPaymentData</dt>
<dd>
<p>Method that should generate a new PaymentData. The method receives a newly generated preImageHash, used
to uniquely identify the payment flow, and an OrderRequest, containing data from PaymentRequired annotation. This is the
first call in a payment flow and the implementation should for example look up the order amount from the article id,
units and other options in the order request. The generated PaymentData should be at least MinimalPaymentData with
preImageHash and orderedAmount set. It is recommended that the PaymentData is persisted in this call but could
be skipped for performance in certain payment flows.</p>
</dd>
<dt class="hdlist1">findPaymentData</dt>
<dd>
<p>Method used by the paywall framework to lookup a PaymentData from a preImageHash.</p>
</dd>
<dt class="hdlist1">updatePaymentData</dt>
<dd>
<p>Method called on update events about a given payment data. This could be when the payment is added
as invoice in LND and contains complementary data or when the invoice was settled and has the <em>settled</em> flag set along
with the settled amount (depending on the type of PaymentData used in PaymentHandler). The implementing method should at
least persist the updated payment data. See table <a href="#paymenteventtypes">Available Payment Event Types</a> for list of
different <em>PaymentEventType</em> that might occur.</p>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Table Available Payment Event Types</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ORDER_CREATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event signaling a order was created. This event is never sent to updatePaymentData.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVOICE_CREATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event signaling that a payments invoice have been created by lightning handler.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVOICE_SETTLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event signaling that a invoice have been settled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUEST_EXECUTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event signaling that a payed request has been executed. Only used for payment
  flows with payPerRequest flag set.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below is an excerpts of the required methods to implement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    /**
     * Method that should generate a new PaymentData for a given order request.
     * This is the first call in a payment flow and the implementation should
     * look up the order amount from the article id, units and other options in
     * the order request.
     *
     * The generated PaymentData should be at least MinimalPaymentData with preImageHash
     * and orderedAmount set.
     *
     * It is recommended that the PaymentData is persisted in this call but could
     * be skipped for performance in certain payment flows.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @param orderRequest the specification of the payment data that should be created calculated
     *                     from data in the PaymentRequired annotation.
     * @return a newly generated PaymentData signaling a new payment flow used to
     * create an Order value object.
     * @throws IOException if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred generating new payment data.
     */
    protected abstract PaymentData newPaymentData(byte[] preImageHash, OrderRequest orderRequest) throws IOException, InternalErrorException;

    /**
     * Method to lookup a payment data in the payment handler.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @return return related payment data or null if not found.
     * @throws IOException if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred fetching related payment data.
     */
    protected abstract PaymentData findPaymentData(byte[] preImageHash) throws IOException, InternalErrorException;

    /**
     * Method called on update events about a given payment data. This could be when
     * the payment is added as invoice in LND and contains complementary data or when
     * the invoice was settled and contains settled flag set and settled amount and date
     * (depending on the type of PaymentData used in PaymentHandler).
     *
     * The related payment data (using preImageHash as unique identifier) is automatically
     * looked up and the implementing method should at least persist the updated data.
     *
     * @param type the type of event such as INVOICE_CREATED or INVOICE_SETTLED.
     * @param paymentData the payment data to update and persist.
     * @param context the latest known state of the lightning handler.  Null if no known state exists.
     * @throws IOException if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred updating related payment data.
     */
    protected abstract void updatePaymentData(PaymentEventType type, PaymentData paymentData,
                                          LightningHandlerContext context) throws IOException, InternalErrorException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is an example implementation for Spring Framework, that assumes you have Spring Data Repository for a
FullPaymentData implementation (see <a href="#paymentdata">PaymentData section</a> ), and that supports <em>payPerRequest</em> annotated
services. It also assumes there exists a Spring Data Repository for the Article Ids specified in @PaymentRequired
annotation to look up price for specified Article Id.</p>
</div>
<div class="paragraph">
<p>Using Spring it is important to add the class as a component with name <em>paymentHandler</em> using the
@Component("paymentHandler") annotation on the class level.</p>
</div>
<div class="paragraph">
<p><em>Important:</em> In order for your Spring application to load all beans in the Paywall framework it
is a requirement to also add an annotation <em>@ComponentScan("org.lightningj.paywall.spring")</em> above
one of the target application components, and it is recommended to do this for the PaymentHandler
as a convertion.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/**
 * Demo implementation of a Payment Handler extending SpringPaymentHandler.
 *
 * It creates DemoPaymentData that implements the PerRequestPaymentData interface. (In order to demonstrate
 * support for both request that's valid for a period of time and for a specific request.)
 * by first looking up the article id order (generated by the @PaymentRequired annotation).
 * Then checks the price of the article in ArticleData table to calculate the ordered amount.
 *
 * It also implements the lookup by preImageHash method and update payment data methods by calling
 * related methods in the DemoPaymentDataRepository.
 *
 */
 @ComponentScan("org.lightningj.paywall.spring")
@Component("paymentHandler")
public class DemoPaymentHandler extends SpringPaymentHandler {

    @Autowired
    DemoFullPaymentDataRepository demoPaymentDataRepository;

    @Autowired
    ArticleDataRepository articleDataRepository;

    /**
     * Method that should generate a new PaymentData for a given order request.
     * This is the first call in a payment flow and the implementation should
     * look up the order amount from the article id, units and other options in
     * the order request.
     * &lt;p&gt;
     * The generated PaymentData should be at least MinimalPaymentData with preImageHash
     * and orderedAmount set.
     * &lt;p&gt;
     * It is recommended that the PaymentData is persisted in this call but could
     * be skipped for performance in certain payment flows.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @param orderRequest the specification of the payment data that should be created calculated
     *                     from data in the PaymentRequired annotation.
     * @return a newly generated PaymentData signaling a new payment flow used to
     * create an Order value object.
     * @throws IOException            if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred generating new payment data.
     */
    @Override
    protected PaymentData newPaymentData(byte[] preImageHash, OrderRequest orderRequest) throws IOException, InternalErrorException {
        try{
            DemoFullPaymentData demoPaymentData = new DemoFullPaymentData();
            demoPaymentData.setPreImageHash(preImageHash);
            demoPaymentData.setPayPerRequest(orderRequest.isPayPerRequest());

            ArticleData articleData = articleDataRepository.findByArticleId(orderRequest.getArticleId());
            if(articleData == null){
                throw new InternalErrorException("Internal error creating payment data, article id " + orderRequest.getArticleId() + " doesn't exist in database.");
            }
            long orderPrice = articleData.getPrice() * orderRequest.getUnits(); // Price in satoshis.
            demoPaymentData.setOrderAmount(new BTC(orderPrice));

            demoPaymentDataRepository.save(demoPaymentData);
            return demoPaymentData;
        }catch(Exception e){
            if(e instanceof InternalErrorException){
                throw e;
            }
            throw new InternalErrorException("Error occurred saving DemoPaymentData to database: " + e.getMessage(),e);
        }
    }

    /**
     * Method to lookup a payment data in the payment handler.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @return return related payment data or null if not found.
     * @throws InternalErrorException if internal exception occurred fetching related payment data.
     */
    @Override
    protected PaymentData findPaymentData(byte[] preImageHash) throws InternalErrorException {
        try{
          return demoPaymentDataRepository.findByPreImageHash(Base58.encodeToString(preImageHash));
        }catch(Exception e){
          throw new InternalErrorException("Error occurred fetching DemoPaymentData from database: " + e.getMessage(),e);
        }
    }

    /**
     * Method called on update events about a given payment data. This could be when
     * the payment is added as invoice in LND and contains complementary data or when
     * the invoice was settled and contains settled flag set and settled amount and date
     * (depending on the type of PaymentData used in PaymentHandler).
     * &lt;p&gt;
     * The related payment data (using preImageHash as unique identifier) is automatically
     * looked up and the implementing method should at least persist the updated data.
     *
     * @param type        the type of event such as INVOICE_CREATED or INVOICE_SETTLED.
     * @param paymentData the payment data to update and persist.
     * @param context     the latest known state of the lightning handler.  Null if no known state exists.
     * @throws InternalErrorException if internal exception occurred updating related payment data.
     */
    @Override
    protected void updatePaymentData(PaymentEventType type, PaymentData paymentData, LightningHandlerContext context) throws InternalErrorException {
        try {
            assert paymentData instanceof DemoFullPaymentData;
            demoPaymentDataRepository.save((DemoFullPaymentData) paymentData);
        }catch(Exception e){
            throw new InternalErrorException("Error occurred updating DemoPaymentData to database: " + e.getMessage(),e);
        }
    }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_advanced_paymenthandler_features">Advanced PaymentHandler Features</h5>
<div class="paragraph">
<p>For production ready implementations of a PaymentHandler it is recommended to also override and implement
the method <em>getLightningHandlerContext()</em>. It should return a LightningHandlerContext (i.e. a LNDLightningHandlerContext
if LND backend is used) that contains the latest position of subscribed invoices. This will make restarts of the
application more reliable since invoices that have been settled during a restart of the application will not be missed.</p>
</div>
<div class="paragraph">
<p>The LNDLightningHandlerContext contains two values <em>addIndex</em> and <em>settleIndex</em> indicating from which position the
LNDLightningHandler should start to subscribe to invoice events. When supporting  <em>getLightningHandlerContext()</em> should
the PaymentHandler implementation persist the two values from the LNDLightningHandlerContext received in the
<em>updatePaymentData</em> call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    /**
     * Method to generate the latest LightningHandlerContext of latest
     * known state of the lightning node. Used to make sure the PaymentHandler
     * starts listening on the correct location of the invoice event queue after
     * restart. For LND Nodes should this method return a LNDLightningHandlerContext
     * @return the last known state of lightning handler context.
     * @throws InternalErrorException if internal exception occurred fetching latest known state of lightning handler.
     */
    LightningHandlerContext getLightningHandlerContext() throws InternalErrorException;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="paymentdata">Payment Data</h4>
<div class="paragraph">
<p>PaymentData is a value object, usually stored in a database, that the <em>PaymentHandler</em> manages. There exists
several interfaces to choose from depending on required functionality. The simplest interface is MinimalPaymentData
and it contains the absolute minimal fields necessary to be able to complete a payment flow. And FullPaymentData where
it is possible for the PaymentHandler implementation to control many aspects of the payment flow such as invoice
validity, settlement validity.</p>
</div>
<div class="paragraph">
<p>Each sub-section describes the different types of PaymentData available.</p>
</div>
<div class="sect4">
<h5 id="_minimalpaymentdata">MinimalPaymentData</h5>
<div class="paragraph">
<p>Contains the minimum fields needed in order to support a payment flow, without possibility to host <em>payPerRequest</em> calls.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Table Fields in MinimalPaymentData</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preImageHash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte[]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier of a payment in the system and also used in LightningHandler to identify an invoice. Should be
generated by TokenGenerator when creating an order and not set manually.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">orderAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The requested amount for payment. This can be either a FiatAmount or CryptoAmount but
  always make sure the systems configured CurrencyConverter supports this currency when converting
  into a currency accepted by the LightningHandler later in the payment flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If related invoice have been settled in full.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more details see <a href="javadoc/org/lightningj/paywall/paymenthandler/data/MinimalPaymentData.html">JavaDoc</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_perrequestpaymentdata">PerRequestPaymentData</h5>
<div class="paragraph">
<p>PerRequestPaymentData is a interface extending MinimalPaymentData required when pay per request functionality is used.
It adds two flags that indicate that this payment is payPerRequest and whether the settled call have been executed and
cannot be requested again.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Table Fields in PerRequestPaymentData</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payPerRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag indicating that this payment is for one request only. The implementation
  can take the payPerRequest flag from the order request as guidance, but it is the PaymentHandler
  that ultimately decides if payPerRequest should be set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">executed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if related request have been executed, is set after successful processing
  of a request and used to indicate that it cannot be processed again.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more details see <a href="javadoc/org/lightningj/paywall/paymenthandler/data/PerRequestPaymentData.html">JavaDoc</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_standardpaymentdata">StandardPaymentData</h5>
<div class="paragraph">
<p>The StandardPaymentData extends MinimalPaymentData and adds more information about the invoice and the ability
for the PaymentHandler to control invoice validity and settlement validity.</p>
</div>
<div class="paragraph">
<p>_Note:_In order for a StandardPaymentData to support pay per request flows it has to also implement the PerRequestPaymentData
interface.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Table Fields in StandardPaymentData</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A short description of the payment used in the lightning invoice and might
  be displayed to the end user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CryptoAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount set in the lightning invoice, this is the same as orderAmount if
  the same currency is used in order as in lightning invoice, otherwise is the currency
  converted before creating the invoice in LightningHandler and the actual invoiced amount
  is specified here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The date the invoice was created in LightningHandler.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceExpireDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The date a generated invoice should expire, this value will be used
  when creating invoice in LightningHandler. If null will default invoice validity
  be used to calculate an expire date automatically.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settledAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CryptoAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount that was settled in the LightningHandlers supported crypto currency.
  Should be equal to invoiceAmount if fully settled. Null if invoice isn&#8217;t settled yet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The timestamp the invoice was settled in LightningHandler. Null if not settled yet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementDuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The settlement duration indicates how long time a generated settlement should be valid. If
  not set will a default settlement value be used. In FullPaymentData it is also possible
  to specify an expiration date of an settlement that is used if it&#8217;s required to set a fixed time when
  the settlement should expire, for example if a settlement should be valid the entire day or month.
  <em>If settlement expire date is set it has precedence over settlementDuration.</em>
  <strong>Important:</strong> Data in this field is only set to instruct the settlement token generator of expiration date.
  the actual settlement date is not updated in this field.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more details see <a href="javadoc/org/lightningj/paywall/paymenthandler/data/StandardPaymentData.html">JavaDoc</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_fullpaymentdata">FullPaymentData</h5>
<div class="paragraph">
<p>The FullPaymentData extends both StandardPaymentData and PerRequestPaymentData and adds fields to store
the actual bolt11Invoice and possiblity to specify exact dates for settlement validity, for use cases when
paying for instance for a monthly subscription for a service and want the settlement token to be valid for exactly
those dates.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Table Fields in FullPaymentData</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bolt11Invoice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The bolt11 lightning invoice displayed to the end user before paying and invoice.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementValidFrom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The valid from timestamp used in generated settlement tokens. If null is no valid from used, only validUntil.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementExpireDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The settlement expire date sets the timestamp when a generated settlement token should expire. If
  not set will a settlementDuration be used, and if that is also null will default duration be set.
  This field is useful if a settlement should be valid the entire day or month. <em>If settlement expire date is set it has
  precedence over settlementDuration.</em>
  <strong>Important:</strong> Data in this field is only set to instruct the settlement token generator of expiration date.
  The actual settlement date is not updated in this field.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more details see <a href="javadoc/org/lightningj/paywall/paymenthandler/data/FullPaymentData.html">JavaDoc</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_paymentrequired_annotation">@PaymentRequired Annotation</h3>
<div class="paragraph">
<p>Another of the main components of the framework is the @PaymentRequired annotation used to
mark that a service requires payment and initiates a new payment flow if needed.</p>
</div>
<div class="paragraph">
<p>Currently are only Spring REST Controllers (Annotated with @RestController) supported but other
types of services will be supported in the future.</p>
</div>
<div class="sect3">
<h4 id="_available_paymentrequired_parameters">Available @PaymentRequired Parameters</h4>
<div class="paragraph">
<p>The @PaymentRequired annotation can be customized to create order request information to
the payment handler in various ways. See table below for a full list of available parameters.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Table Available PaymentRequired Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameters</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">articleId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true, see description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the type of order that should be generated, used by PaymentHandler to determine order amount depending
  on article an units. (Required if not a custom OrderRequestGenerator is specified).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">units</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of units for given article number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payPerRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If payment is valid for one request only. If not will the settlement be valid for multiple request
  over a specified time period.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">orderRequestGenerator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DefaultOrderRequestGenerator.class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possibility to specify a custom order request generator, instead of the default one using
  the articleId and units to request an order. See section <a href="#orderrequestgeneratorparameter">Order Request Generator Parameter</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">requestPolicy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WITH_BODY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines what data in HTTP request that is considered relevant for determining a unique payment.
  See section <a href="#requestpolicyparameter">Request Policy Parameter</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">customPolicy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NoCustomRequestPolicy.class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The custom class if none of the predefined request policy types isn&#8217;t applicable and a custom implementation is necessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paymentOptions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set of custom extra options sent to payment handler when creating an order for an invoice. Each value should
  be of class org.lightningj.paywall.annotations.vo.PaymentOption that have two fields, <em>option</em> which acts as a key and <em>value</em> that contains
  the actual value.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_examples_of_paymentrequired_annotations">Examples of @PaymentRequired Annotations</h4>
<div class="paragraph">
<p>The @PaymentRequired annotation can be placed on either the method or class level. If placed before
the class declaration is all methods paywalled with the same parameters.</p>
</div>
<div class="paragraph">
<p>Below is an example of a pay walled method where a payment request request is initiated with article id "abc123"
sent the payment handler to create an order for.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RestController
public class Poc1RestController {

    private static final String template = "PocService1, %s!";
    private final AtomicLong counter = new AtomicLong();

    @PaymentRequired(articleId = "abc123")
    @RequestMapping("/poc1")
    public PocResult poc1(@RequestParam(value="name", defaultValue="Poc1") String name) {
        return new PocResult(counter.incrementAndGet(),
                String.format(template, name));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If payment should be done per-request and not for a specified time add a payPerRequest
parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RestController
public class Poc1RestController {

    private static final String template = "PocService1, %s!";
    private final AtomicLong counter = new AtomicLong();

    @PaymentRequired(articleId = "abc123", payPerRequest = true)
    @RequestMapping("/poc1")
    public PocResult poc1(@RequestParam(value="name", defaultValue="Poc1") String name) {
        return new PocResult(counter.incrementAndGet(),
                String.format(template, name));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If all methods should be pay walled in a class with the same parameters add the annotation
before the class declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@PaymentRequired(articleId = "abc456")
@RestController
public class Poc1RestController {

    private static final String template = "PocService1, %s!";
    private final AtomicLong counter = new AtomicLong();

    @RequestMapping("/poc1")
    public PocResult poc1(@RequestParam(value="name", defaultValue="Poc1") String name) {
        return new PocResult(counter.incrementAndGet(),
                String.format(template, name));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="requestpolicyparameter">The Request Policy Parameter</h4>
<div class="paragraph">
<p>The request policy is in-charge of calculating a cryptographic hash of all significant data for
a given payment flow. This is used to determine if a given settlement is valid for a related request.</p>
</div>
<div class="paragraph">
<p>For example if a service should require payment for access to a given REST WebService for a given amount of time
it should specify URL_AND_METHOD and all types of requests to that URL and METHOD will be allowed
until the related settlement expires (given that <em>payPerRequest</em> is set to false). What happens under the hood is that
the URL and METHOD in the original request was included in the cryptographic hash and no other data. After successful
payment and when the same request is snet again will the new requests URL and HTTP method be matched against the
original one.</p>
</div>
<div class="paragraph">
<p>There exists a set of defined types of request policies that calculate the unique request
from a given set of data.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. Table Available Pre-defined Request Policy Options</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL_AND_METHOD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy that checks the URL and Method of a request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL_METHOD_AND_PARAMETERS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy that checks the URL and Method and all parameters of a request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WITH_BODY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy that checks the URL, Method, all parameters and full body data of a HTTP request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CUSTOM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom implementation of calculating significant request data.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_creating_a_custom_request_policy">Creating a Custom Request Policy</h5>
<div class="paragraph">
<p>To create a custom request policy, create a class that implements <em>org.lightningj.paywall.requestpolicy.RequestPolicy</em>.
It contains one required method significantRequestDataDigest that calculates a request.</p>
</div>
<div class="paragraph">
<p>The RequestPolicy interface have the following method defined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface RequestPolicy {

    /**
     * Method in charge of generating a digest
     * of all significant data in a request that is needed
     * to determine that the call is same that is invoiced
     *
     * @param request the cachable http servlet request to aggregate request data for.
     * @return a RequestData containing a secure cryptographic digest of all significant request data.
     *
     * @throws IllegalArgumentException if supplied request contained invalid data.
     * @throws IOException if i/o related problems occurred reading the request data.
     * @throws InternalErrorException if internal errors occurred reading the request data.
     */
    RequestData significantRequestDataDigest(CachableHttpServletRequest request) throws IllegalArgumentException, IOException, InternalErrorException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A tip is to aggregate all data required in a <em>ByteArrayOutputStream</em> and the create the cryptographic hash value
with the <em>DigestUtils.sha256(baos.toByteArray())</em> help method.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="orderrequestgeneratorparameter">The Order Request Generator Parameter</h4>
<div class="paragraph">
<p>By default is an OrderRequest generated to the PaymentHandler containing and article id, number of units, the
payPerRequest flag and the list of paymentOptions. But it is possible the create a custom OrderRequestGenerator
for specific purposes.</p>
</div>
<div class="paragraph">
<p>One use-case for creating a custom order request generator would be if the article Id or payment options should
be decided dynamically depending on data in the http request, such as body json data, instead of static data from
the @PaymentRequired annotation.</p>
</div>
<div class="sect4">
<h5 id="_creating_a_custom_order_request_generator">Creating a Custom Order Request Generator</h5>
<div class="paragraph">
<p>To create a custom order generator create a class implementing <em>org.lightningj.paywall.orderrequestgenerator.OrderRequestGenerator</em>
that contains one method that should generate a new OrderRequest object from the related PaymentRequired annotation
and HTTP Request object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface OrderRequestGenerator {

    /**
     * Method that should populate a new OrderRequest to initiate a
     * payment flow using the PaymentRequired annotation and the
     * related HTTP request.
     * @param paymentRequired the related annotation.
     * @param request the HTTP request related to the call.
     * @return a new OrderRequest.
     * @throws IllegalArgumentException if user supplied data was invalid to generate order request.
     * @throws InternalErrorException if problem occurred generated order request data due to internal miss configuration.
     */
    OrderRequest generate(PaymentRequired paymentRequired, CachableHttpServletRequest request) throws IllegalArgumentException, InternalErrorException;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_payment_flows">Payment Flows</h3>
<div class="paragraph">
<p>The framework is designed to work in different system configurations. It not always desirable for
all micro services to have a direct connection with a lightning node but would like to centralise
this functionality to a central system handling the payment and the actual the paywalled service just
redirects the user to the central payment server until a settlement token have been issued and the requester
is redirected back to the original system.</p>
</div>
<div class="paragraph">
<p>Currently is only one payment flow supported, the <em>local payment flow</em>, but others will be added in the future.</p>
</div>
<div class="sect3">
<h4 id="_local_payment_flow">Local Payment Flow</h4>
<div class="paragraph">
<p>The default, and currently only payment flow available, is the <em>local payment flow</em>. It&#8217;s used when
the same system have all paywall components in same system (CheckSettlement controller, WebSocket Service,
LightningHandler etc) and have a direct connection with a lightning node.</p>
</div>
<div class="paragraph">
<p>Below is a flow chart describing all the steps in the local payment flow in detail. The blue boxes
indicate components that is a part of the target application, the rest is part of the Paywall framework.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/FlowDiagram-1-3-PaywallInterceptor.png" alt="FlowDiagram 1 3 PaywallInterceptor">
</div>
<div class="title">Figure 1. Flow Chart of Payment Interceptor using Local Payment Flow.</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">1.1 PaywallInterceptor intercept the request</dt>
<dd>
<p>This component is a part of the <em>paywall-spring</em> component and is
configured to parse all incoming request</p>
</dd>
<dt class="hdlist1">1.2 RestController in target application</dt>
<dd>
<p>The PaywallInterceptor lookup if target controller contains a
@PaymentRequired annotation. If that is the case and no valid settlement token exists in the HTTP header is a new
Payment Flow initiated.</p>
</dd>
<dt class="hdlist1">1.3 RequestPolicy Bean generates significant data</dt>
<dd>
<p>The request policy type is fetched up from the @PaymentRequired
annotation. And then is the significant data from the request calculated.</p>
</dd>
<dt class="hdlist1">1.4 OrderRequestGenerator generates a OrderRequest</dt>
<dd>
<p>The order request generator is fetched from
the @PaymentRequired annotation. And a order request, usually article id and units, is created.</p>
</dd>
<dt class="hdlist1">1.5 TokenGenerator generates PreImageData</dt>
<dd>
<p>The token generator bean generates a random preImage and preImageHash that
is used to uniquely identify the payment flow and use in the lightning invoice.</p>
</dd>
<dt class="hdlist1">1.6 PaymentHandler is called to generate an Order</dt>
<dd>
<p>The payment handler is called to create a new PaymentData which is
used to create and keep track of an invoice. This is done by calling the method
 <em>PaymentData newPaymentData(byte[] preImageHash, OrderRequest orderRequest)</em> that needs to be implemented by the target
application.</p>
</dd>
<dt class="hdlist1">1.7 CurrencyConverter converts amount to used crypto currency</dt>
<dd>
<p>The defined CurrencyConverter is called to optionally
convert the amount in the Order to the crypto amount used by the LightningHandler. By default is no conversion
performed and the payment handler is required to create orders with amount in CryptoAmount (i.e BTC).</p>
</dd>
<dt class="hdlist1">1.8 LightningHandler is called to create a lightning invoice</dt>
<dd>
<p>The configured LightningHandler is called
to create an invoice for the related payment. The LightningHandler also subscribes to settlement and updates the
PaymentHandler asynchronously using an event bus.</p>
</dd>
<dt class="hdlist1">1.9 TokenGenerator generates Invoice JWT Token</dt>
<dd>
<p>The token generator generates a signed and encrypted JWT (Java Web Token)
of type <em>invoice</em> used to certify the requester as <em>owner</em> of this payment flow and used when checking settlement.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Finally will the PaywallInterceptor generate a <a href="#invoicejson">Invoice JSON Data structure</a> and return it with HTTP
status code 402.</p>
</div>
<div class="paragraph">
<p>The next step in the flow is for the requester to check settlement. This can be done in two way either
by polling a Check Settlement REST API, or by subscribing to a pushed settlement messsage
over a WebSocket (used the the Javascript library by default). The flow diagram describes the inner workings of
the Check Settlement Controller.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/FlowDiagram-2-CheckSettlement.png" alt="FlowDiagram 2 CheckSettlement">
</div>
<div class="title">Figure 2. Flow Chart of Check Settlement Controller Logic in Local Payment Flow.</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">2.1 Check Settlement Controller</dt>
<dd>
<p>A HTTP GET Request to check payment status. The controller
fetches for Invoice HTTP parameter <em>pwir</em> from the request URL.</p>
</dd>
<dt class="hdlist1">2.2 TokenGenerator parses the Invoice Token</dt>
<dd>
<p>Token Generator parses and validates the JWT and extracts
the preImageHash.</p>
</dd>
<dt class="hdlist1">2.3 The PaymentHandler is used to lookup the related PaymentData</dt>
<dd>
<p>The PaymentHandler&#8217;s
<em>PaymentData findPaymentData(byte[] preImageHash)</em> is called (that needs to be implemented by the target application)
to look up settlement status.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the related PaymentData is marked as settled is 2.4 called otherwise is an empty
<a href="#settlementjson">Settlement JSON Data Structure</a> returned with only the field <em>settled</em> set to <em>false</em>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">2.4 Token Generator generates a Settlement Token</dt>
<dd>
<p>TokenGenerator generates an encrypted
and signed JWT of type <em>settlement</em>. Finally is a populated  <a href="#settlementjson">Settlement JSON Data Structure</a>
returned with all fields set.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The third step in the payment flow is for the request to call the target API again, this time with
the settlement token set as HTTP Header with name <em>Payment</em>. This step is displayed in the first flow chart.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">3.1 The PaywallInterceptor inspects the request again</dt>
<dd>
<p>This time it determines that settlement token
exists and starts with verification of payment.</p>
</dd>
<dt class="hdlist1">3.2 TokenGenerator parses the Settlement Token</dt>
<dd>
<p>The settlement token is parsed and validated.
It also checks if related payment is payPerRequest and if that is the case is step 3.3 called.</p>
</dd>
<dt class="hdlist1">3.3 PaymentHandler checks if request already have been executed</dt>
<dd>
<p>The PaymentHandler is called using the
<em>PaymentData findPaymentData(byte[] preImageHash)</em> method to verify that the request haven&#8217;t already been processed.</p>
</dd>
<dt class="hdlist1">3.4 RequestPolicy Bean generates significant data of new request</dt>
<dd>
<p>The significant data is calculated again.</p>
</dd>
<dt class="hdlist1">3.5 PaywallInterceptor calls paywalled controller</dt>
<dd>
<p>If significant data matches with data in settlement token will the
PaywallInterceptor let the request go through to the underlying controller.</p>
</dd>
<dt class="hdlist1">3.6 After the Target API have processed the request</dt>
<dd>
<p>If the payment flow is of type <em>payPerRequest</em> is PaymentHandler&#8217;s
method <em>void updatePaymentData(PaymentEventType type, PaymentData paymentData, LightningHandlerContext context)</em>
called with PaymentEventType set to <em>PaymentEventType.REQUEST_EXECUTED</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Finally it the response generated by the target API returned to the requester.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_customizing_paywall_components">Customizing Paywall Components</h3>
<div class="paragraph">
<p>Most of the components used in the Paywall framework can be customized by implementing the related interface
or overriding existing classes. This section details how to customize some of them.</p>
</div>
<div class="sect3">
<h4 id="_custom_currencyconverter">Custom CurrencyConverter</h4>
<div class="paragraph">
<p>A CurrencyConverter is in charge of converting the Amount specified in an Order created by the PaymentHandler
into the Amount that should be used in the Lightning invoice. One use-case is if the PaymentHandler returns the amount
in FIAT USD and the LightningHandler requires BTC. Then a CurrencyConverter is needed to convert the amount.</p>
</div>
<div class="paragraph">
<p>By default is <em>SameCryptoCurrencyConverter</em> used which doesn&#8217;t do any conversion. It is assumed the PaymentHandler will
return the Amount in the cryptocurrency used by the LightningHandler (i.e. BTC).</p>
</div>
<div class="paragraph">
<p>To customize, implement the interface <em>org.lightningj.paywall.currencyconverter.CurrencyConverter</em> that has one method
<em>CryptoAmount convert(Amount amount)</em> that needs to be implemented. See
<a href="javadoc/org/lightningj/paywall/currencyconverter/CurrencyConverter.html">JavaDoc</a> for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_lightninghandler">Custom LightningHandler</h4>
<div class="paragraph">
<p>A LightningHandler is in charge of connecting to a lightning node and create and subscribe to invoices. There exists
one LND implementation in paywall-core (actually two classes Base and Simple) and one extension in paywall-spring adding
Spring related functionality.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 8. Table Available PaymentRequired Parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">LND Implementation Class</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">JavaDoc Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BaseLNDLightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base implementation of LND Lightning Handler handling the methods for generateInvoice, lookupInvoice and invoice
subscribing. See SimpleBaseLNDLightningHandler that manages APIs, opening/closing connection. Extends this if custom
management of LND APIs should be done, otherwise use SimpleBaseLNDLightningHandler.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="javadoc/org/lightningj/paywall/lightninghandler/lnd/BaseLNDLightningHandler.html">JavaDoc</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SimpleBaseLNDLightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extension of BaseLNDLightningHandler that also manages APIs and opening/closing connection. Implementing classes only
need to give host,port, path to TLS cert and macaroon.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="javadoc/org/lightningj/paywall/lightninghandler/lnd/SimpleBaseLNDLightningHandler.html">JavaDoc</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SpringLNDLightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring implementation of LND Lightning Handler.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="javadoc/org/lightningj/paywall/lightninghandler/lnd/SpringLNDLightningHandler.html">JavaDoc</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To implement a custom LightningHandler implement the interface <em>org.lightningj.paywall.lightninghandler.LightningHandler</em>. See
<a href="javadoc/org/lightningj/paywall/lightninghandler/LightningHandler.html">JavaDoc</a> for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_keymanager">Custom KeyManager</h4>
<div class="paragraph">
<p>A KeyManager is in-charge of maintaining cryptographic keys with in the system. There exists two types of
key managers, SymmetricKeyManager managing symmetric keys
(<a href="javadoc/org/lightningj/paywall/keymgmt/SymmetricKeyManager.html">JavaDoc</a>), and AsymmetricKeyManager
(<a href="javadoc/org/lightningj/paywall/keymgmt/AsymmetricKeyManager.html">JavaDoc</a>) managing asymmetric keys.</p>
</div>
<div class="paragraph">
<p>Asymmetric keys is used in payment flows requiring multiple systems where trust needs to be set up between them.</p>
</div>
<div class="paragraph">
<p>The default implementation is DefaultFileKeyManager that implements both SymmetricKeyManager and AsymmetricKeyManager and
stores the keys on local disk, encrypted by a passphrase and generates the needed keys automatically when needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_tokengenerator">Custom TokenGenerator</h4>
<div class="paragraph">
<p>The TokenGenerator is responsible for generating signed and encrypted JWT Tokens and PreImageData. There exists two
implementations of TokenGenerator, SymmetricKeyTokenGenerator using symmetric key manager and used in the local payment
flow, and AsymmetricKeyTokenGenerator using asymmetric keys for payment flows requiring setting up trust between
different systems.</p>
</div>
<div class="paragraph">
<p>There are three type of JST tokens defined in table below. The local payment flow only uses
the Invoice and Settlement tokens.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 9. Table Available PaymentRequired Parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">JWT Token Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Contains Data</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Payment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used in distributed payment flows where JWT token contains Order information to create a PaymentData.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OrderRequest, Order, RequestData</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains information about a lightning invoice, used when checking for settlement to prove ownership of the
payment flow.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OrderRequest, MinimalInvoice, RequestData</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settlement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains information that an invoice have been settled, including how for how long the settlement
is valid.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OrderRequest, Settlement, RequestData</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To create a customized TokenGenerator implement the interface <em>org.lightningj.paywall.tokengenerator.TokenGenerator</em>
See <a href="javadoc/org/lightningj/paywall/tokengenerator/TokenGenerator.html">JavaDoc</a> for details.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-08-17 22:35:50 CEST
</div>
</div>
</body>
</html>