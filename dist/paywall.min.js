/*! paywall.min.js file */

!function(e){"use strict";e.PaywallState={NEW:"NEW",INVOICE:"INVOICE",INVOICE_EXPIRED:"INVOICE_EXPIRED",SETTLED:"SETTLED",EXECUTED:"EXECUTED",SETTLEMENT_NOT_YET_VALID:"SETTLEMENT_NOT_YET_VALID",SETTLEMENT_EXPIRED:"SETTLEMENT_EXPIRED",PAYWALL_ERROR:"PAYWALL_ERROR",ABORTED:"ABORTED"},e.PaywallEventType={INVOICE:"INVOICE",INVOICE_EXPIRED:"INVOICE_EXPIRED",SETTLED:"SETTLED",EXECUTED:"EXECUTED",SETTLEMENT_NOT_YET_VALID:"SETTLEMENT_NOT_YET_VALID",SETTLEMENT_EXPIRED:"SETTLEMENT_EXPIRED",PAYWALL_ERROR:"PAYWALL_ERROR",ALL:"ALL"},e.PaywallResponseStatus={OK:"OK",BAD_REQUEST:"BAD_REQUEST",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE",UNAUTHORIZED:"UNAUTHORIZED",INTERNAL_SERVER_ERROR:"INTERNAL_SERVER_ERROR"},e.BTCUnit={BTC:"BTC",MILLIBTC:"MILLIBTC",BIT:"BIT",SAT:"SAT",MILLISAT:"MILLISAT",NANOSAT:"NANOSAT"};var N=402,D="PAYWALL_MESSAGE",a="NONE",o="MILLI",r="NANO",l="BTC";function _(o){var r=[],l=o.paywall.getState();var t=setInterval(function(){var e=o.paywall.getState();l!==e&&(l=e)!==PaywallState.SETTLED&&(function(e){switch(e){case PaywallState.NEW:case PaywallState.INVOICE:case PaywallState.SETTLEMENT_NOT_YET_VALID:case PaywallState.SETTLED:return!1}return!0}(e)&&clearInterval(t),n(a(e),s(e)))},1e3);this.close=function(){clearInterval(t)};this.addListener=function(e,t,n){var a=i(e);-1===a?r.push({name:e,type:t,onEvent:n}):r.splice(a,1,{name:e,type:t,onEvent:n})};this.addListenerFirst=function(e,t,n){var a=i(e);-1!==a&&r.splice(a,1),r.unshift({name:e,type:t,onEvent:n})};this.removeListener=function(e){var t=i(e);-1!==t&&r.splice(t,1)};var n=function(t,e){l=o.paywall.getState();for(var n=r.filter(function(e){return e.type===t||e.type===PaywallEventType.ALL}),a=0;a<n.length;a++)n[a].onEvent(t,e)};this.onEvent=n;function i(e){for(var t=0;t<r.length;t++)if(r[t].name===e)return t;return-1}function a(e){switch(e){case PaywallState.INVOICE:return PaywallEventType.INVOICE;case PaywallState.INVOICE_EXPIRED:return PaywallEventType.INVOICE_EXPIRED;case PaywallState.SETTLED:return PaywallEventType.SETTLED;case PaywallState.EXECUTED:return PaywallEventType.EXECUTED;case PaywallState.SETTLEMENT_NOT_YET_VALID:return PaywallEventType.SETTLEMENT_NOT_YET_VALID;case PaywallState.SETTLEMENT_EXPIRED:return PaywallEventType.SETTLEMENT_EXPIRED;case PaywallState.PAYWALL_ERROR:return PaywallEventType.PAYWALL_ERROR;case PaywallState.API_ERROR:return PaywallEventType.API_ERROR}throw"Invalid state sent to Paywall EventBus: "+e}function s(e){switch(e){case PaywallState.INVOICE:case PaywallState.INVOICE_EXPIRED:return o.paywall.getInvoice();case PaywallState.SETTLED:case PaywallState.EXECUTED:case PaywallState.SETTLEMENT_NOT_YET_VALID:case PaywallState.SETTLEMENT_EXPIRED:return o.paywall.getSettlement();case PaywallState.PAYWALL_ERROR:return o.paywall.getPaywallError()}throw"Invalid state sent to Paywall EventBus: "+e}this.triggerEventFromState=function(){var e=o.paywall.getState();n(a(e),s(e))}}function O(e,a){var o,r;function l(e){if(e.body){var t=JSON.parse(e.body);if(t.status===PaywallResponseStatus.OK){var n=function(e){var t=Date.now();if(null!==e.settlementValidFrom&&new Date(e.settlementValidFrom).getTime()>t)return PaywallEventType.SETTLEMENT_NOT_YET_VALID;if(new Date(e.settlementValidUntil).getTime()<t)return PaywallEventType.SETTLEMENT_EXPIRED;return PaywallEventType.SETTLED}(t);console.debug("Paywall WebSocket, received message if type: "+n),a.onEvent(n,t)}else console.debug("Paywall WebSocket, received error message: "+t),a.onEvent(PaywallEventType.PAYWALL_ERROR,t)}else console.debug("Paywall WebSocket, received empty message, ignoring.")}function i(e){var t;t=void 0!==e.headers?{status:PaywallResponseStatus.SERVICE_UNAVAILABLE,message:e.headers.message,errors:[e.headers.message]}:{status:PaywallResponseStatus.SERVICE_UNAVAILABLE,message:e,errors:[e]},console.debug("Paywall WebSocket connection error: "+t),a.onEvent(PaywallEventType.PAYWALL_ERROR,t)}this.connect=function(t){o=new SockJS(e.paywall.genCheckSettlementWebSocketLink()),r=Stomp.over(o);var n={token:t.token};r.connect({},function(e){r.subscribe(t.checkSettlementWebSocketQueue,l,n)},i)};this.close=function(){void 0!==r&&(console.debug("Paywall WebSocket, closing connection."),r.disconnect(),o.close())}}e.PaywallHttpRequest=function(){var t,n,a,o=!1,r=!1,l=new XMLHttpRequest,i=!1,s={method:null,url:null,async:!0,username:null,password:null,eventListeners:[],uploadEventListeners:[]},E={body:null,requestHeaders:[]};function e(){if(void 0!==a)return PaywallState.PAYWALL_ERROR;if(r)return PaywallState.ABORTED;if(o)return PaywallState.EXECUTED;if(void 0===t&&void 0===n)return PaywallState.NEW;var e=Date.now();return void 0===n?new Date(t.invoiceExpireDate).getTime()<e?PaywallState.INVOICE_EXPIRED:PaywallState.INVOICE:null!==n.settlementValidFrom&&new Date(n.settlementValidFrom).getTime()>e?PaywallState.SETTLEMENT_NOT_YET_VALID:new Date(n.settlementValidUntil).getTime()<e?PaywallState.SETTLEMENT_EXPIRED:PaywallState.SETTLED}function u(e){return e.startsWith("http")?e:window.location.origin+e}function d(e,t,n,a){var o=T(e,t);-1===o?e.push({type:t,callback:n,options:a}):e.splice(o,1,{type:t,callback:n,options:a})}function c(e,t){var n=T(t);-1!==n&&e.splice(n,1)}function T(e,t){for(var n=0;n<e.length;n++)if(e[n].type===t)return n;return-1}function v(){R(),S()}function p(e,t){e===PaywallEventType.SETTLED&&(A.close(),i=!1,n=t,(l=new XMLHttpRequest).onreadystatechange=v,f(),void 0===s.async?l.open(s.method,s.url):l.open(s.method,s.url,s.async,s.username,s.password),I(),P(),l.send(E.body))}function y(){i?l.readyState===XMLHttpRequest.DONE&&(L()?w():(t=JSON.parse(l.responseText),g.triggerEventFromState(),g.addListenerFirst("OnReadyStateListener",PaywallEventType.ALL,p),A.connect(t))):l.readyState===XMLHttpRequest.HEADERS_RECEIVED?l.status===N?i=!0:(R(),f(),S()):(R(),S(),L()&&w())}function L(){if(l.readyState===XMLHttpRequest.DONE&&"TRUE"===l.getResponseHeader(D)){var e=l.status/100;if(4==e||5==e)return!0}return!1}function w(){a=JSON.parse(l.responseText),g.onEvent(PaywallEventType.PAYWALL_ERROR,a)}function S(){void 0!==h.onstatechange&&(h.readyState=l.readyState,h.onstatechange()),l.readyState!==XMLHttpRequest.DONE||void 0===n||!n.payPerRequest||2==l.status/100&&(o=!0,g.onEvent(PaywallEventType.EXECUTED,n))}function m(){l.ontimeout=h.ontimeout,l.onabort=h.onabort,l.onerror=h.onerror;for(var e=0;e<s.eventListeners.length;e++){var t=s.eventListeners[e];"timeout"!==t.type&&"abort"!==t.type&&"error"!==t.type||l.addEventListener(t.type,t.callback,t.options)}if(void 0!==l.upload){l.upload.ontimeout=h.upload.ontimeout,l.upload.onabort=h.upload.onabort,l.upload.onerror=h.upload.onerror;for(var n=0;n<s.uploadEventListeners.length;n++){var a=s.uploadEventListeners[n];"timeout"!==a.type&&"abort"!==a.type&&"error"!==a.type||l.upload.addEventListener(a.type,a.callback,a.options)}}}function f(){l.onloadstart=h.onloadstart,l.onload=h.onload,l.onprogress=h.onprogress,l.onabort=h.onabort,l.onerror=h.onerror,l.ontimeout=h.ontimeout,l.onloadend=h.onloadend;for(var e=0;e<s.eventListeners.length;e++){var t=s.eventListeners[e];l.addEventListener(t.type,t.callback,t.options)}if(void 0!==l.upload){l.upload.onloadstart=h.upload.onloadstart,l.upload.onload=h.upload.onload,l.upload.onprogress=h.upload.onprogress,l.upload.onabort=h.upload.onabort,l.upload.onerror=h.upload.onerror,l.upload.ontimeout=h.upload.ontimeout,l.upload.onloadend=h.upload.onloadend;for(var n=0;n<s.uploadEventListeners.length;n++){var a=s.uploadEventListeners[n];l.upload.addEventListener(a.type,a.callback,a.options)}}}function I(){l.timeout=h.timeout,l.withCredentials=h.withCredentials}function P(){e()===PaywallState.SETTLED&&l.setRequestHeader("Payment",h.paywall.getSettlement().token)}function R(e){h.status=l.status,h.statusText=l.statusText,h.responseURL=l.responseURL,void 0!==e&&!1!==e||(h.responseType=l.responseType,h.response=l.response,h.responseText=l.responseText,h.responseXML=l.responseXML)}var h={timeout:0,withCredentials:!1,upload:{onload:void 0,onloadstart:void 0,onloadend:void 0,onerror:void 0,onprogress:void 0,onstatechange:void 0,ontimeout:void 0,addEventListener:function(e,t,n){d(s.uploadEventListeners,e,t,n)},removeEventListener:function(e,t,n){c(s.uploadEventListeners,e)},dispatchEvent:function(e){throw"Internal dispatchEvent should never be called."}},readyState:XMLHttpRequest.UNSENT,responseURL:void 0,status:void 0,statusText:void 0,responseType:void 0,response:void 0,responseText:void 0,responseXML:void 0,onload:void 0,onloadstart:void 0,onloadend:void 0,onerror:void 0,onprogress:void 0,onstatechange:void 0,ontimeout:void 0,addEventListener:function(e,t,n){d(s.eventListeners,e,t,n)},removeEventListener:function(e,t,n){c(s.eventListeners,e)},dispatchEvent:function(e){throw"Internal dispatchEvent should never be called."},abort:function(){r=!0,g.close(),A.close(),l.abort()},setRequestHeader:function(e,t){E.requestHeaders.push({name:e,value:t})},open:function(e,t,n,a,o){s.method=e,s.url=t,E={body:null,requestHeaders:[]},l.onreadystatechange=y,m(),void 0===n?l.open(e,t):(s.async=n,s.username=a,s.password=o,l.open(e,t,n,a,o))},send:function(e){E.body=e,I(),m();for(var t=0;t<E.requestHeaders.length;t++){var n=E.requestHeaders[0];l.setRequestHeader(n.name,n.value)}P(),l.send(e)},getResponseHeader:function(e){return l.getResponseHeader(e)},getAllResponseHeaders:function(){return l.getAllResponseHeaders()},overrideMimeType:function(e){return l.overrideMimeType(e)},paywall:{getInvoice:function(){return t},hasInvoice:function(){return void 0!==t},getInvoiceExpiration:function(){if(void 0!==t)return new PaywallTime(t.invoiceExpireDate);throw"Invalid state "+e()+" when calling method getInvoiceExpiration()."},getInvoiceAmount:function(){if(void 0!==t)return new PaywallAmount(t.invoiceAmount);throw"Invalid state "+e()+" when calling method getInvoiceAmount()."},getSettlement:function(){return n},hasSettlement:function(){return void 0!==n},getSettlementExpiration:function(){if(void 0!==n)return new PaywallTime(n.settlementValidUntil);throw"Invalid state "+e()+" when calling method getSettlementExpiration()."},getSettlementValidFrom:function(){if(void 0!==n)return null!=n.settlementValidFrom?new PaywallTime(n.settlementValidFrom):new PaywallTime((new Date).toDateString());throw"Invalid state "+e()+" or when calling method getSettlementValidFrom()."},genQRLink:function(){if(void 0!==t)return u(t.qrLink);throw"Invalid state "+e()+" or when calling method genQRLink()."},genCheckSettlementLink:function(){if(void 0!==t)return u(t.checkSettlementLink);throw"Invalid state "+e()+" or when calling method genCheckSettlementLink()."},genCheckSettlementWebSocketLink:function(){if(void 0!==t)return u(t.checkSettlementWebSocketEndpoint);throw"Invalid state "+e()+" or when calling method genCheckSettlementWebSocketLink()."},getPaywallError:function(){return a},getState:e,addEventListener:function(e,t,n){g.addListener(e,t,n)},removeEventListener:function(e){g.removeListener(e)}}},g=new _(h),A=new O(h,g);return h},e.PaywallTime=function(e){var t=new Date(e);return{getTimeStamp:function(){return t},remaining:function(){return new PaywallTimeUnit(t.getTime()-Date.now())}}},e.PaywallTimeUnit=function(e){e<0&&(e=0);function t(e){return e<10?"0"+e:""+e}return{asMS:function(){return e},seconds:function(){return t(Math.floor(e%6e4/1e3))},minutes:function(){return t(Math.floor(e%36e5/6e4))},hours:function(){return t(Math.floor(e%864e5/36e5))},days:function(){return""+Math.floor(e/864e5)}}},e.PaywallAmount=function(n){return{as:function(e){var t=function(){if(void 0===n.value)throw"Invalid invoice amount object in PaywallAmount.";if(void 0!==n.currencyCode&&n.currencyCode!==l)throw"Invalid invoice currency code "+n.currencyCode+" in PaywallAmount, currently only BTC is supported.";var e=a;switch(void 0!==n.magnetude&&(e=n.magnetude),e){case a:return n.value;case o:return n.value/1e3;case r:return n.value/1e6}throw"Invalid magnetude from invoice "+e+" in PaywallAmount."}();switch(e){case BTCUnit.BTC:return t/1e8;case BTCUnit.MILLIBTC:return t/1e5;case BTCUnit.BIT:return t/100;case BTCUnit.SAT:return t;case BTCUnit.MILLISAT:return 1e3*t;case BTCUnit.NANOSAT:return 1e6*t;default:throw"Unsupported unit "+e+" used with PaywallAmount, only BTCUnit enumerated values are supported"}}}}}(this);